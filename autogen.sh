#!/bin/bash

if [ -z $LIBTOOLIZE ] ; then
    LIBTOOLIZE=$(type -P libtoolize)
    if [ -z $LIBTOOLIZE ] ; then
        LIBTOOLIZE=$(type -P glibtoolize)
    fi
fi
if [ -z $LIBTOOL ] ; then
    LIBTOOL=$(type -P "${LIBTOOLIZE%???}")
fi

if [ -z $LIBTOOL ] || [ -z $LIBTOOLIZE ] ; then
    echo "Unable to find working libtool. [$LIBTOOL][$LIBTOOLIZE]"
    exit 1
fi

# Make a new Makefile.am in src
BASE_DIR=`pwd`

#cd $BASE_DIR/src/sst/elements
#echo "# Autogenerated by SST Autogen" > Makefile.am
#echo -n "SUBDIRS = " > Makefile.am
#
#FOUND_ONE_ELEMENT=0
#
#
#for elem_dir in `ls ./`; do 
#	if [ -d $elem_dir ]; then
#		if [ -r $elem_dir/Makefile.am ]; then
#			echo "Found: $elem_dir/Makefile.am"
#			echo " \\" >> Makefile.am
#			echo -n "     $elem_dir" >> Makefile.am
#		fi
#
#		if [ $FOUND_ONE_ELEMENT -eq 0 ]; then
#			sst_elements="$elem_dir"
#			FOUND_ONE_ELEMENT=1
#		else
#			sst_elements="$sst_elements $elem_dir"
#		fi
#	fi
#done
#
#cd $BASE_DIR

echo "AC_DEFUN([SST_ELEMENT_CONFIG_OUTPUT], [" > config/sst_elements_config_output.m4
echo "dnl Automatically generated by SST configuration system" > config/sst_elements_include.m4

for file in `ls $BASE_DIR/src/sst/elements`; do
	echo "Generating Configuration for $file Makefile..."

	if [ -d "$BASE_DIR/src/sst/elements/$file" ]; then
		if [ -r "$BASE_DIR/src/sst/elements/$file/configure.m4" ]; then
			echo "   SST_${file}_CONFIG([config_${file}=1],[config_${file}=0])" >> config/sst_elements_config_output.m4
			echo "   AS_IF([test \$config_${file} -eq 1], [AC_CONFIG_FILES([src/sst/elements/$file/Makefile])])" >> config/sst_elements_config_output.m4
			echo "   AS_IF([test \$config_${file} -eq 1], [active_element_libraries=\"\$active_element_libraries $file\"])" >> config/sst_elements_config_output.m4
			echo "m4_include([src/sst/elements/$file/configure.m4])" >> config/sst_elements_include.m4
		else
			if [ -r "$BASE_DIR/src/sst/elements/$file/Makefile.am" ]; then
				echo "   AC_CONFIG_FILES([src/sst/elements/$file/Makefile])" >> config/sst_elements_config_output.m4
				echo "   active_element_libraries=\"\$active_element_libraries $file\"" >> config/sst_elements_config_output.m4
			fi
		fi
	fi
done

echo '   SST_ACTIVE_ELEMENT_LIBRARIES="$active_element_libraries"' >> config/sst_elements_config_output.m4
echo '   SST_DIST_ELEMENT_LIBRARIES="$active_element_libraries"' >> config/sst_elements_config_output.m4
echo "   AC_SUBST(SST_ACTIVE_ELEMENT_LIBRARIES)" >> config/sst_elements_config_output.m4
echo "])" >> config/sst_elements_config_output.m4

# Delete the old libtool output
rm -rf libltdl src/libltdl

echo "Running ${LIBTOOLIZE}..."
$LIBTOOLIZE --automake --copy --ltdl

if test -d libltdl; then
        echo "Moving libltdl to src .."
        mv libltdl ./src/
fi

if test ! -d src/libltdl ; then
    echo "libltdl for elements exist.  Aborting."
    exit 1
fi

aclocal -I config
autoheader
autoconf
automake --foreign --add-missing --include-deps
autoreconf --force --install
